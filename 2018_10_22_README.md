# KPN1053 alignments (2018-10-22)

In this part the following steps were executed:
  - Download ~ 200 references
  - Select the best one
  - Align Klebsiella reads against reference

See all results here: http://195.208.116.225/bioinf/Klebsiella/8_alignment_without_plasmids/

## Installation requirements
See https://github.com/dariader/Klebsiella/blob/alignments/README.md

## 1. Data preperation

You can find more instructions here: https://www.ncbi.nlm.nih.gov/genome/doc/ftpfaq/

### 1.1 Find and download all available Klebsiella pneumaniae genomes

This command will download NCBI assembly summary, which contains all available bacteria genomes:
```
wget ftp://ftp.ncbi.nlm.nih.gov/genomes/refseq/bacteria/assembly_summary.txt
```

Then we can find all Klebsiella pneumaniae complete genomes:
```
awk -F "\t" '$8=="Klebsiella pneumoniae" &&  $12=="Complete Genome" && $11=="latest" {print $20}' assembly_summary.txt > klebsiella_pneumaniae_genomes.txt
```

Let's calculate number of found genomes:
```
wc -l klebsiella_pneumaniae_genomes.txt 

212 klebsiella_pneumaniae_genomes.txt
```

// TODO: download GFF files for best genome later
Download all selected genomes:
```
time cat ../klebsiella_pneumaniae_genomes.txt | parallel --gnu "wget {}"
```

Construct full FTP paths to selected genomes:
```
awk 'BEGIN { FS=OFS="/"; filesuffix="genomic.fna.gz" }{ ftpdir=$0;asm=$10;file=asm"_"filesuffix; print ftpdir,file }' klebsiella_pneumaniae_genomes.txt > klebsiella_pneumaniae_genome_paths.txt
```

Create a directory for Klebsiella genomes:

```
 mkdir klebsiella_reference
 cd ./klebsiella_reference/
```

Download all selected genomes:
```
time cat ../klebsiella_pneumaniae_genome_paths.txt | parallel --gnu "wget {}"

real	45m28.196s
user	0m2.496s
sys	0m6.151s
```

Unzip genomes:
```
gunzip ../../data/klebsiella_reference/*.fna.gz
```

Split genomes to chromosomes and plasmids:
```
time ls ../../../data/klebsiella_reference/ | xargs -n 1 basename | parallel --gnu "faidx -x ../../../data/klebsiella_reference/{}"
```

Create directory:
```
mkdir klebsiella_assembly_reports
```


Create paths to assembly reports:
```
awk 'BEGIN { FS=OFS="/"; filesuffix="assembly_report.txt" }{ ftpdir=$0;asm=$10;file=asm"_"filesuffix; print ftpdir,file }' klebsiella_pneumaniae_genomes.txt > klebsiella_pneumaniae_genome_reports.txt

wc -l klebsiella_pneumaniae_genome_reports.txt
212 klebsiella_pneumaniae_genome_reports.txt
```

Download all assembly reports:
```
time cat ../klebsiella_pneumaniae_genome_reports.txt | parallel --gnu "wget {}"

real	60m39.766s
user	0m2.153s
sys	0m3.175s
```
